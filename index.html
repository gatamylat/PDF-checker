<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>–ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä—Ç–µ–∂–µ–π</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f5f5f7;
            --bg-tertiary: #e8e8ed;
            --text-primary: #1d1d1f;
            --text-secondary: #86868b;
            --text-tertiary: #aeaeb2;
            --separator: rgba(0, 0, 0, 0.1);
            --accent: #007aff;
            --accent-hover: #0051d5;
            --destructive: #ff3b30;
            --success: #34c759;
            --card-bg: #ffffff;
            --shadow: rgba(0, 0, 0, 0.1);
            --overlay: rgba(0, 0, 0, 0.4);
        }

        [data-theme="dark"] {
            --bg-primary: #000000;
            --bg-secondary: #1c1c1e;
            --bg-tertiary: #2c2c2e;
            --text-primary: #ffffff;
            --text-secondary: #98989d;
            --text-tertiary: #636366;
            --separator: rgba(255, 255, 255, 0.1);
            --accent: #0a84ff;
            --accent-hover: #409cff;
            --destructive: #ff453a;
            --success: #32d74b;
            --card-bg: #1c1c1e;
            --shadow: rgba(0, 0, 0, 0.3);
            --overlay: rgba(0, 0, 0, 0.6);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            display: flex;
            flex-direction: column;
            height: 100vh;
            height: 100dvh;
            overflow: hidden;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .header {
            background: var(--bg-secondary);
            border-bottom: 0.5px solid var(--separator);
            padding: 8px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            min-height: 44px;
            z-index: 100;
        }

        .header-title {
            font-size: 17px;
            font-weight: 600;
            letter-spacing: -0.4px;
        }

        .main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
            position: relative;
        }

        .pdf-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: var(--bg-secondary);
        }

        .pdf-toolbar {
            background: var(--bg-primary);
            border-bottom: 0.5px solid var(--separator);
            padding: 8px 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            min-height: 44px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .pdf-toolbar::-webkit-scrollbar {
            display: none;
        }

        .page-controls {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .zoom-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .zoom-slider {
            width: 120px;
            height: 4px;
            background: var(--separator);
            border-radius: 2px;
            outline: none;
            -webkit-appearance: none;
            appearance: none;
            cursor: pointer;
        }

        .zoom-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            background: var(--accent);
            border-radius: 50%;
            cursor: pointer;
        }

        .zoom-slider::-moz-range-thumb {
            width: 16px;
            height: 16px;
            background: var(--accent);
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }

        .zoom-select {
            padding: 6px 8px;
            background: var(--bg-secondary);
            border: 0.5px solid var(--separator);
            color: var(--text-primary);
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            outline: none;
        }

        .zoom-select:focus {
            border-color: var(--accent);
        }

        .page-info {
            font-size: 13px;
            color: var(--text-secondary);
            white-space: nowrap;
            min-width: 60px;
            text-align: center;
        }

        button {
            background: none;
            border: none;
            color: var(--accent);
            font-size: 17px;
            padding: 6px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 400;
            white-space: nowrap;
            transition: background-color 0.2s ease;
            -webkit-tap-highlight-color: transparent;
        }

        button:hover {
            background: var(--bg-tertiary);
        }

        button:active {
            opacity: 0.6;
        }

        button.icon-only {
            width: 36px;
            height: 36px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        button.primary {
            background: var(--accent);
            color: white;
        }

        button.primary:hover {
            background: var(--accent-hover);
        }

        button.destructive {
            color: var(--destructive);
        }

        button.success {
            background: var(--success);
            color: white;
        }

        button.success:hover {
            opacity: 0.9;
        }

        .pdf-viewers {
            flex: 1;
            display: flex;
            gap: 8px;
            padding: 12px;
            overflow: hidden;
        }

        .pdf-viewer {
            flex: 1;
            background: var(--bg-tertiary);
            border-radius: 12px;
            overflow: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            position: relative;
            -webkit-overflow-scrolling: touch;
        }

        .pdf-viewer.hidden {
            display: none;
        }

        .pdf-viewer-label {
            position: absolute;
            top: 12px;
            left: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.6px;
            color: var(--text-tertiary);
            background: var(--bg-primary);
            padding: 4px 10px;
            border-radius: 6px;
            z-index: 10;
        }

        canvas {
            border-radius: 8px;
            box-shadow: 0 4px 16px var(--shadow);
            background: white;
            max-width: 100%;
            height: auto;
        }

        .sidebar {
            width: 380px;
            background: var(--bg-primary);
            border-left: 0.5px solid var(--separator);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: transform 0.35s cubic-bezier(0.32, 0.72, 0, 1);
        }

        .sidebar.collapsed {
            transform: translateX(100%);
        }

        @media (min-width: 769px) {
            .main-container {
                transition: margin-right 0.35s cubic-bezier(0.32, 0.72, 0, 1);
            }

            .sidebar {
                position: fixed;
                right: 0;
                top: 44px;
                bottom: 0;
                height: auto;
                z-index: 500;
            }

            .sidebar.collapsed {
                transform: translateX(100%);
            }

            .pdf-container {
                transition: margin-right 0.35s cubic-bezier(0.32, 0.72, 0, 1);
                margin-right: 380px;
            }

            .pdf-container.sidebar-hidden {
                margin-right: 0;
            }

            /* Desktop: PDFs side by side, no wrapper between them */
            .pdf-viewers {
                flex-direction: row;
            }

            .second-controls-wrapper {
                display: none !important;
            }
        }

        .sidebar-header {
            background: var(--bg-secondary);
            border-bottom: 0.5px solid var(--separator);
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            min-height: 44px;
        }

        .sidebar-tabs {
            display: flex;
            background: var(--bg-secondary);
            border-bottom: 0.5px solid var(--separator);
        }

        .sidebar-tab {
            flex: 1;
            padding: 12px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            border-bottom: 2px solid transparent;
            transition: color 0.2s ease;
        }

        .sidebar-tab.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            -webkit-overflow-scrolling: touch;
        }

        .sidebar-content::-webkit-scrollbar {
            width: 6px;
        }

        .sidebar-content::-webkit-scrollbar-thumb {
            background: var(--separator);
            border-radius: 3px;
        }

        .tab-panel {
            display: none;
        }

        .tab-panel.active {
            display: block;
        }

        h2 {
            font-size: 22px;
            font-weight: 700;
            letter-spacing: -0.5px;
            margin-bottom: 16px;
        }

        .checklist-section {
            margin-bottom: 24px;
        }

        .checklist-section h3 {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }

        .checklist-item {
            background: var(--card-bg);
            border: 0.5px solid var(--separator);
            border-radius: 10px;
            padding: 12px 14px;
            margin-bottom: 8px;
            transition: all 0.2s ease;
        }

        .checklist-item:active {
            transform: scale(0.98);
        }

        .checklist-item label {
            display: flex;
            align-items: start;
            cursor: pointer;
            font-size: 15px;
            line-height: 1.4;
        }

        .checklist-item input[type="checkbox"] {
            margin-right: 12px;
            margin-top: 2px;
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: var(--accent);
        }

        .checklist-item.checked {
            opacity: 0.5;
            background: var(--bg-secondary);
        }

        .notes-area {
            width: 100%;
            min-height: 200px;
            padding: 12px;
            background: var(--card-bg);
            border: 0.5px solid var(--separator);
            border-radius: 10px;
            color: var(--text-primary);
            font-family: 'SF Mono', 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            resize: vertical;
            line-height: 1.5;
        }

        .notes-area:focus {
            outline: none;
            border-color: var(--accent);
        }

        .product-info {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 16px;
        }

        .product-input {
            width: 100%;
            padding: 10px 12px;
            background: var(--card-bg);
            border: 0.5px solid var(--separator);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
        }

        .product-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .templates-section {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        .template-btn,
        .history-btn {
            flex: 1;
            padding: 8px 12px;
            background: var(--bg-secondary);
            border: 0.5px solid var(--separator);
            color: var(--text-primary);
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            transition: background-color 0.2s;
        }

        .template-btn:hover,
        .history-btn:hover {
            background: var(--bg-tertiary);
        }

        .templates-dropdown {
            display: none;
            flex-direction: column;
            gap: 4px;
            margin-bottom: 12px;
            padding: 8px;
            background: var(--bg-secondary);
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
        }

        .templates-dropdown.show {
            display: flex;
        }

        .template-item {
            padding: 8px 12px;
            background: var(--card-bg);
            border: 0.5px solid var(--separator);
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            transition: background-color 0.2s;
        }

        .template-item:hover {
            background: var(--bg-tertiary);
        }

        .history-section {
            margin-top: 12px;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .export-buttons {
            margin-top: 12px;
            display: flex;
            gap: 8px;
        }

        .export-buttons button {
            flex: 1;
            padding: 12px;
            font-size: 15px;
            font-weight: 600;
        }

        .fab {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 56px;
            height: 56px;
            background: var(--accent);
            color: white;
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 4px 16px rgba(0, 122, 255, 0.4);
            z-index: 1000;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .fab:active {
            transform: scale(0.9);
        }

        .fab.rotated {
            transform: rotate(45deg);
        }

        .menu-dropdown {
            position: absolute;
            top: 52px;
            left: 16px;
            background: var(--card-bg);
            border: 0.5px solid var(--separator);
            border-radius: 12px;
            padding: 8px;
            min-width: 200px;
            display: none;
            flex-direction: column;
            box-shadow: 0 8px 24px var(--shadow);
            z-index: 200;
            backdrop-filter: blur(20px);
        }

        .menu-dropdown.show {
            display: flex;
        }

        .menu-item {
            padding: 10px 12px;
            border-radius: 8px;
            text-align: left;
            font-size: 15px;
            color: var(--text-primary);
            background: transparent;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .menu-item:hover {
            background: var(--bg-secondary);
        }

        .menu-separator {
            height: 0.5px;
            background: var(--separator);
            margin: 4px 0;
        }

        .file-input-wrapper {
            display: inline-block;
            position: relative;
        }

        input[type="file"] {
            position: absolute;
            opacity: 0;
            width: 0;
            height: 0;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: var(--overlay);
            backdrop-filter: blur(10px);
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: var(--bg-primary);
            border-radius: 16px;
            width: 90%;
            max-width: 800px;
            max-height: 85vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.35s cubic-bezier(0.32, 0.72, 0, 1);
        }

        @keyframes slideUp {
            from { 
                transform: translateY(50px);
                opacity: 0;
            }
            to { 
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            padding: 20px 20px 16px;
            border-bottom: 0.5px solid var(--separator);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 20px;
        }

        .modal-close {
            background: var(--bg-secondary);
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: var(--text-secondary);
        }

        .modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            -webkit-overflow-scrolling: touch;
        }

        .modal-body::-webkit-scrollbar {
            width: 6px;
        }

        .modal-body::-webkit-scrollbar-thumb {
            background: var(--separator);
            border-radius: 3px;
        }

        .editor-section {
            margin-bottom: 20px;
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: 12px;
            border: 0.5px solid var(--separator);
        }

        .editor-section-header {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        .editor-section-header input {
            flex: 1;
            padding: 10px 12px;
            background: var(--card-bg);
            border: 0.5px solid var(--separator);
            color: var(--text-primary);
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
        }

        .editor-section-header input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .editor-item {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        }

        .editor-item input {
            flex: 1;
            padding: 10px 12px;
            background: var(--card-bg);
            border: 0.5px solid var(--separator);
            color: var(--text-primary);
            border-radius: 8px;
            font-size: 14px;
        }

        .editor-item input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .modal-footer {
            padding: 16px 20px;
            border-top: 0.5px solid var(--separator);
            display: flex;
            gap: 8px;
        }

        .modal-footer button {
            flex: 1;
            padding: 12px;
            font-size: 15px;
            font-weight: 600;
        }

        .modal-footer button.destructive {
            background: #ff3b30;
            color: white;
        }

        .modal-footer button.destructive:hover {
            background: #ff2d1f;
        }

        .history-item {
            padding: 12px;
            background: var(--card-bg);
            border: 0.5px solid var(--separator);
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .history-item:hover {
            background: var(--bg-tertiary);
        }

        .history-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .history-item-title {
            font-weight: 600;
            font-size: 14px;
            color: var(--text-primary);
        }

        .history-item-date {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .history-item-article {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .history-item-stats {
            font-size: 12px;
            color: var(--text-tertiary);
        }

        .template-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            background: var(--card-bg);
            border: 0.5px solid var(--separator);
            border-radius: 6px;
            margin-bottom: 6px;
        }

        .template-text {
            flex: 1;
            font-size: 13px;
            color: var(--text-primary);
            word-break: break-word;
        }

        .template-delete {
            padding: 4px 8px;
            background: #ff3b30;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-left: 8px;
        }

        .template-delete:hover {
            background: #ff2d1f;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 12px;
        }

        .comments-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding: 12px;
            background: var(--bg-secondary);
            border-radius: 8px;
        }

        .comments-stats {
            display: flex;
            flex-direction: column;
            gap: 4px;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .comments-stats span {
            color: var(--text-primary);
            font-weight: 600;
        }

        .comments-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .comment-item {
            padding: 12px;
            background: var(--card-bg);
            border: 0.5px solid var(--separator);
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .comment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .comment-type {
            font-size: 12px;
            padding: 2px 8px;
            background: var(--accent);
            color: white;
            border-radius: 4px;
        }

        .comment-page {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .comment-content {
            font-size: 14px;
            color: var(--text-primary);
            line-height: 1.4;
            white-space: pre-wrap;
        }

        .annotation-overlay {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
            z-index: 10;
        }

        .annotation-marker {
            position: absolute;
            pointer-events: all;
            cursor: help;
            transition: opacity 0.2s;
        }

        .annotation-marker:hover {
            opacity: 0.8;
        }

        .annotation-marker.highlight {
            background: rgba(255, 235, 59, 0.3);
            border: 1px solid rgba(255, 235, 59, 0.6);
        }

        .annotation-marker.text {
            width: 24px;
            height: 24px;
            background: #FFC107;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 14px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .annotation-tooltip {
            position: absolute;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            max-width: 300px;
            z-index: 1000;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .annotation-tooltip.show {
            opacity: 1;
        }

        .annotation-tooltip-author {
            font-weight: 600;
            color: var(--accent);
            margin-bottom: 6px;
            font-size: 12px;
        }

        .annotation-tooltip-content {
            font-size: 14px;
            line-height: 1.4;
            color: var(--text-primary);
        }

        .annotation-tooltip-type {
            font-size: 11px;
            color: var(--text-tertiary);
            margin-top: 6px;
            padding-top: 6px;
            border-top: 1px solid #eee;
        }

        .toast {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--card-bg);
            color: var(--text-primary);
            padding: 12px 20px;
            border-radius: 20px;
            box-shadow: 0 8px 24px var(--shadow);
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 3000;
            font-size: 15px;
            border: 0.5px solid var(--separator);
            backdrop-filter: blur(20px);
        }

        .toast.show {
            opacity: 1;
        }

        @media (max-width: 768px) {
            .header-title {
                font-size: 15px;
            }

            .pdf-toolbar {
                padding: 6px 10px;
                gap: 8px;
            }

            button {
                font-size: 15px;
                padding: 5px 10px;
            }

            button.icon-only {
                width: 32px;
                height: 32px;
                font-size: 18px;
            }

            .pdf-viewers {
                padding: 8px;
                gap: 0;
                flex-direction: column;
            }

            .pdf-viewer {
                border-radius: 10px;
                padding: 12px;
                width: 100%;
            }

            .pdf-viewer.hidden {
                display: none !important;
            }

            /* Controls wrapper between viewers - ONLY in portrait mobile */
            .second-controls-wrapper {
                width: 100%;
                background: var(--bg-primary);
                padding: 12px;
                border-radius: 10px;
                display: none;
                flex-direction: row;
                gap: 16px;
                align-items: center;
                justify-content: center;
                border: 0.5px solid var(--separator);
                margin: 8px 0;
                flex-wrap: wrap;
            }

            .second-controls-wrapper.show {
                display: flex;
            }

            .second-controls-wrapper .page-controls,
            .second-controls-wrapper .zoom-controls {
                display: flex !important;
            }

            .sidebar {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                width: 100%;
                height: 50%;
                max-height: 50vh;
                border-left: none;
                border-top: 0.5px solid var(--separator);
                border-radius: 16px 16px 0 0;
                z-index: 500;
                transform: translateY(100%);
                transition: transform 0.35s cubic-bezier(0.32, 0.72, 0, 1);
                box-shadow: 0 -8px 24px var(--shadow);
            }

            .sidebar.collapsed {
                transform: translateY(100%);
            }

            .sidebar:not(.collapsed) {
                transform: translateY(0);
            }

            .fab {
                display: flex;
            }

            .menu-dropdown {
                left: auto;
                right: 16px;
                top: auto;
                bottom: 86px;
            }

            .modal-content {
                width: 95%;
                max-height: 90vh;
                border-radius: 12px;
            }

            .checklist-item {
                padding: 8px 10px;
            }

            .checklist-item label {
                font-size: 13px;
            }

            .checklist-item input[type="checkbox"] {
                width: 18px;
                height: 18px;
                margin-right: 10px;
            }

            .checklist-section h3 {
                font-size: 13px;
                margin-bottom: 10px;
            }

            h2 {
                font-size: 18px;
                margin-bottom: 12px;
            }

            .sidebar-content {
                padding: 12px;
            }

            .zoom-slider {
                width: 80px;
            }

            .zoom-select {
                font-size: 12px;
                padding: 4px 6px;
            }
        }

        /* Landscape orientation for mobile */
        @media (max-width: 932px) and (max-height: 430px) and (orientation: landscape) {
            .header {
                padding: 4px 12px;
                min-height: 36px;
            }

            .header-title {
                font-size: 14px;
            }

            .pdf-toolbar {
                padding: 4px 8px;
                min-height: 36px;
            }

            button.icon-only {
                width: 28px;
                height: 28px;
                font-size: 16px;
            }

            button {
                font-size: 13px;
                padding: 4px 8px;
            }

            .page-info {
                font-size: 12px;
            }

            .pdf-container {
                width: 100%;
                margin-right: 0;
            }

            .pdf-viewers {
                padding: 4px;
                gap: 4px;
                flex-direction: row;
            }

            .pdf-viewer {
                padding: 4px;
                border-radius: 8px;
            }

            .pdf-viewer-label {
                font-size: 10px;
                padding: 3px 8px;
                top: 6px;
                left: 6px;
            }

            /* Hide second controls wrapper in landscape */
            .second-controls-wrapper {
                display: none !important;
            }

            .sidebar {
                position: fixed;
                top: 36px;
                right: 0;
                bottom: 0;
                left: auto;
                width: 320px;
                height: auto;
                max-height: none;
                border-left: 0.5px solid var(--separator);
                border-top: none;
                border-radius: 0;
                z-index: 500;
                transform: translateX(100%);
                transition: transform 0.35s cubic-bezier(0.32, 0.72, 0, 1);
                box-shadow: -8px 0 24px var(--shadow);
            }

            .sidebar.collapsed {
                transform: translateX(100%);
            }

            .sidebar:not(.collapsed) {
                transform: translateX(0);
            }

            .sidebar-header {
                padding: 6px 12px;
                min-height: 32px;
            }

            .sidebar-header h2 {
                font-size: 14px;
            }

            .sidebar-tabs {
                min-height: 32px;
            }

            .sidebar-tab {
                padding: 6px 8px;
                font-size: 12px;
            }

            .sidebar-content {
                padding: 8px;
            }

            h2 {
                font-size: 15px;
                margin-bottom: 8px;
            }

            .checklist-section {
                margin-bottom: 12px;
            }

            .checklist-section h3 {
                font-size: 11px;
                margin-bottom: 6px;
            }

            .checklist-item {
                padding: 5px 8px;
                margin-bottom: 4px;
                border-radius: 6px;
            }

            .checklist-item label {
                font-size: 11px;
                line-height: 1.3;
            }

            .checklist-item input[type="checkbox"] {
                width: 14px;
                height: 14px;
                margin-right: 6px;
                margin-top: 1px;
            }

            .notes-area {
                min-height: 100px;
                padding: 8px;
                font-size: 11px;
            }

            .export-buttons button {
                padding: 6px 8px;
                font-size: 12px;
            }

            .fab {
                width: 44px;
                height: 44px;
                bottom: 12px;
                right: 12px;
                font-size: 18px;
            }

            .menu-dropdown {
                bottom: 60px;
                right: 12px;
                min-width: 180px;
                padding: 6px;
            }

            .menu-item {
                padding: 6px 8px;
                font-size: 13px;
            }

            .toast {
                bottom: 50px;
                padding: 8px 14px;
                font-size: 12px;
            }

            .modal-content {
                max-height: 75vh;
            }

            .modal-header {
                padding: 10px 12px;
            }

            .modal-header h2 {
                font-size: 15px;
            }

            .modal-body {
                padding: 10px;
            }

            .modal-footer {
                padding: 8px 12px;
            }

            .modal-footer button {
                padding: 8px;
                font-size: 13px;
            }

            .editor-section {
                padding: 10px;
                margin-bottom: 10px;
            }

            .editor-item {
                margin-bottom: 6px;
            }

            .editor-item input,
            .editor-section-header input {
                padding: 6px 8px;
                font-size: 12px;
            }

            .zoom-slider {
                width: 60px;
            }

            .zoom-select {
                font-size: 11px;
                padding: 3px 5px;
            }

            .zoom-controls {
                gap: 4px;
            }
        }

        @media (min-width: 769px) and (max-width: 1024px) {
            .sidebar {
                width: 340px;
            }
        }

        @media print {
            .header,
            .pdf-toolbar,
            .sidebar,
            .fab,
            .toast {
                display: none !important;
            }

            .pdf-container {
                border: none;
            }

            canvas {
                box-shadow: none;
            }
        }

        @media (prefers-reduced-motion: reduce) {
            * {
                animation: none !important;
                transition: none !important;
            }
        }
    </style>
</head>
<body data-theme="light">
    <div class="header">
        <button class="icon-only" id="menuBtn">‚ò∞</button>
        <div class="header-title">–ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä—Ç–µ–∂–µ–π</div>
        <button class="icon-only" id="sidebarToggle">‚óß</button>
    </div>

    <div class="menu-dropdown" id="menuDropdown">
        <div class="file-input-wrapper">
            <button class="menu-item" onclick="document.getElementById('pdf1').click()">
                <span>üìÑ</span> –ó–∞–≥—Ä—É–∑–∏—Ç—å –æ—Å–Ω–æ–≤–Ω–æ–π
            </button>
            <input type="file" id="pdf1" accept=".pdf">
        </div>
        <div class="file-input-wrapper">
            <button class="menu-item" onclick="document.getElementById('pdf2').click()">
                <span>üìë</span> –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
            </button>
            <input type="file" id="pdf2" accept=".pdf">
        </div>
        <div class="menu-separator"></div>
        <button class="menu-item" id="singleViewBtn">
            <span>üìÑ</span> –û–¥–∏–Ω –¥–æ–∫—É–º–µ–Ω—Ç
        </button>
        <button class="menu-item" id="dualViewBtn">
            <span>üìä</span> –†–µ–∂–∏–º —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
        </button>
        <div class="menu-separator"></div>
        <button class="menu-item" id="editChecklistBtn">
            <span>‚öôÔ∏è</span> –†–µ–¥–∞–∫—Ç–æ—Ä –æ–ø—Ä–æ—Å–Ω–∏–∫–∞
        </button>
        <button class="menu-item" id="themeToggleBtn">
            <span id="themeIcon">üåô</span> <span id="themeText">–¢—ë–º–Ω–∞—è —Ç–µ–º–∞</span>
        </button>
    </div>

    <div class="main-container">
        <div class="pdf-container">
            <div class="pdf-toolbar">
                <div class="page-controls">
                    <button class="icon-only" id="prevPage">‚Äπ</button>
                    <span class="page-info">
                        <span id="pageNum">0</span> / <span id="pageCount">0</span>
                    </span>
                    <button class="icon-only" id="nextPage">‚Ä∫</button>
                </div>
                
                <div class="zoom-controls">
                    <input type="range" id="zoomSlider1" min="50" max="300" value="150" step="10" class="zoom-slider">
                    <select id="zoomSelect1" class="zoom-select">
                        <option value="50">50%</option>
                        <option value="75">75%</option>
                        <option value="100">100%</option>
                        <option value="125">125%</option>
                        <option value="150" selected>150%</option>
                        <option value="175">175%</option>
                        <option value="200">200%</option>
                        <option value="250">250%</option>
                        <option value="300">300%</option>
                    </select>
                </div>
                
                <button class="icon-only" id="syncToggle" title="–°–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è" style="display: none;">üîó</button>
                
                <div class="page-controls" id="viewer2Controls" style="display: none;">
                    <button class="icon-only" id="prevPage2">‚Äπ</button>
                    <span class="page-info">
                        <span id="pageNum2Display">0</span> / <span id="pageCount2Display">0</span>
                    </span>
                    <button class="icon-only" id="nextPage2">‚Ä∫</button>
                </div>
                
                <div class="zoom-controls" id="zoomControls2" style="display: none;">
                    <input type="range" id="zoomSlider2" min="50" max="300" value="150" step="10" class="zoom-slider">
                    <select id="zoomSelect2" class="zoom-select">
                        <option value="50">50%</option>
                        <option value="75">75%</option>
                        <option value="100">100%</option>
                        <option value="125">125%</option>
                        <option value="150" selected>150%</option>
                        <option value="175">175%</option>
                        <option value="200">200%</option>
                        <option value="250">250%</option>
                        <option value="300">300%</option>
                    </select>
                </div>
            </div>

            <div class="pdf-viewers">
                <div class="pdf-viewer" id="viewer1">
                    <div class="pdf-viewer-label">–û—Å–Ω–æ–≤–Ω–æ–π</div>
                    <canvas id="canvas1"></canvas>
                </div>
                
                <div class="second-controls-wrapper" id="secondControlsWrapper">
                    <div class="page-controls" id="viewer2ControlsMobile">
                        <button class="icon-only" id="prevPage2Mobile">‚Äπ</button>
                        <span class="page-info">
                            <span id="pageNum2DisplayMobile">0</span> / <span id="pageCount2DisplayMobile">0</span>
                        </span>
                        <button class="icon-only" id="nextPage2Mobile">‚Ä∫</button>
                    </div>
                    
                    <div class="zoom-controls" id="zoomControls2Mobile">
                        <input type="range" id="zoomSlider2Mobile" min="50" max="300" value="150" step="10" class="zoom-slider">
                        <select id="zoomSelect2Mobile" class="zoom-select">
                            <option value="50">50%</option>
                            <option value="75">75%</option>
                            <option value="100">100%</option>
                            <option value="125">125%</option>
                            <option value="150" selected>150%</option>
                            <option value="175">175%</option>
                            <option value="200">200%</option>
                            <option value="250">250%</option>
                            <option value="300">300%</option>
                        </select>
                    </div>
                </div>
                
                <div class="pdf-viewer hidden" id="viewer2">
                    <div class="pdf-viewer-label">–°—Ä–∞–≤–Ω–µ–Ω–∏–µ</div>
                    <canvas id="canvas2"></canvas>
                </div>
            </div>
        </div>

        <div class="sidebar collapsed" id="sidebar">
            <div class="sidebar-header">
                <h2 style="margin: 0; font-size: 17px;">–ü–∞–Ω–µ–ª—å</h2>
                <button class="icon-only" id="closeSidebar">‚úï</button>
            </div>

            <div class="sidebar-tabs">
                <button class="sidebar-tab active" data-tab="checklist">–û–ø—Ä–æ—Å–Ω–∏–∫</button>
                <button class="sidebar-tab" data-tab="notes">–ó–∞–º–µ—Ç–∫–∏</button>
                <button class="sidebar-tab" data-tab="comments">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</button>
            </div>

            <div class="sidebar-content">
                <div class="tab-panel active" id="checklist">
                    <h2>–ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä—Ç–µ–∂–∞</h2>
                </div>

                <div class="tab-panel" id="notes">
                    <h2>–ó–∞–º–µ—Ç–∫–∏</h2>
                    
                    <div class="product-info">
                        <input type="text" id="productName" class="product-input" placeholder="–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –∏–∑–¥–µ–ª–∏—è">
                        <input type="text" id="productArticle" class="product-input" placeholder="–ê—Ä—Ç–∏–∫—É–ª –∏–∑–¥–µ–ª–∏—è">
                    </div>
                    
                    <div class="templates-section">
                        <button class="template-btn" id="showTemplates">üìù –®–∞–±–ª–æ–Ω—ã</button>
                        <button class="template-btn" id="manageTemplates">‚öôÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞–º–∏</button>
                    </div>
                    
                    <div class="templates-dropdown" id="templatesDropdown"></div>
                    
                    <textarea class="notes-area" id="notesText" placeholder="–í–∞—à–∏ –∑–∞–º–µ—á–∞–Ω–∏—è –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏..."></textarea>
                    
                    <div class="export-buttons">
                        <button class="primary" id="copyNotes">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
                        <button class="primary" id="copyTelegram">üì± Telegram</button>
                        <button class="success" id="exportNotes">–≠–∫—Å–ø–æ—Ä—Ç</button>
                    </div>
                    
                    <div class="history-section">
                        <button class="history-btn" id="showHistory">üìú –ò—Å—Ç–æ—Ä–∏—è –ø—Ä–æ–≤–µ—Ä–æ–∫</button>
                        <button class="history-btn" id="exportBackup">üíæ –≠–∫—Å–ø–æ—Ä—Ç –±—ç–∫–∞–ø–∞</button>
                        <button class="history-btn" id="importBackup">üì• –ò–º–ø–æ—Ä—Ç –±—ç–∫–∞–ø–∞</button>
                        <input type="file" id="backupFile" accept=".json" style="display: none;">
                    </div>
                </div>

                <div class="tab-panel" id="comments">
                    <h2>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –≤ PDF</h2>
                    
                    <div class="comments-info">
                        <div class="comments-stats" id="commentsStats">
                            <span>üìÑ –°—Ç—Ä–∞–Ω–∏—Ü–∞: <span id="currentPageComments">‚Äî</span></span>
                            <span>üí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤: <span id="commentsCount">0</span></span>
                        </div>
                        <button class="template-btn" id="extractAllComments">üìã –í—Å–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã</button>
                    </div>
                    
                    <div class="comments-list" id="commentsList">
                        <div class="empty-state">
                            <div class="empty-state-icon">üí¨</div>
                            <p>–ó–∞–≥—Ä—É–∑–∏—Ç–µ PDF —Å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º–∏</p>
                        </div>
                    </div>
                    
                    <div class="export-buttons" style="margin-top: 16px;">
                        <button class="primary" id="copyComments">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
                        <button class="success" id="exportComments">–≠–∫—Å–ø–æ—Ä—Ç</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <button class="fab" id="fab">+</button>

    <div class="modal" id="editorModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>–†–µ–¥–∞–∫—Ç–æ—Ä –æ–ø—Ä–æ—Å–Ω–∏–∫–∞</h2>
                <button class="modal-close" id="closeModal">‚úï</button>
            </div>
            
            <div class="modal-body">
                <div class="checklist-section" style="background: var(--bg-secondary); padding: 12px; border-radius: 8px; margin-bottom: 16px;">
                    <h3 style="font-size: 12px; font-weight: 600; color: var(--text-secondary); margin-bottom: 8px;">–í–ò–ó–£–ê–õ–ò–ó–ê–¶–ò–Ø</h3>
                    <div class="checklist-item" style="background: var(--bg-primary);">
                        <input type="checkbox" id="showAnnotationMarkers">
                        <label for="showAnnotationMarkers">–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –º–∞—Ä–∫–µ—Ä—ã –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –Ω–∞ —á–µ—Ä—Ç–µ–∂–µ</label>
                    </div>
                </div>
                <div id="editorSections"></div>
            </div>
            
            <div class="modal-footer">
                <button class="success" id="saveChecklist">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button id="resetChecklist">–°–±—Ä–æ—Å</button>
                <button id="cancelEdit">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>

    <div class="modal" id="historyModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>–ò—Å—Ç–æ—Ä–∏—è –ø—Ä–æ–≤–µ—Ä–æ–∫</h2>
                <button class="modal-close" id="closeHistory">‚úï</button>
            </div>
            
            <div class="modal-body" id="historyList" style="max-height: 60vh; overflow-y: auto;"></div>
            
            <div class="modal-footer">
                <button class="destructive" id="clearHistory">–û—á–∏—Å—Ç–∏—Ç—å</button>
                <button id="closeHistoryBtn">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>

    <div class="modal" id="templatesModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞–º–∏</h2>
                <button class="modal-close" id="closeTemplates">‚úï</button>
            </div>
            
            <div class="modal-body">
                <div id="templatesList"></div>
                <div style="margin-top: 16px;">
                    <textarea id="newTemplateText" placeholder="–¢–µ–∫—Å—Ç –Ω–æ–≤–æ–≥–æ —à–∞–±–ª–æ–Ω–∞..." style="width: 100%; min-height: 80px; padding: 10px; border-radius: 8px; border: 0.5px solid var(--separator); background: var(--card-bg); color: var(--text-primary); font-size: 14px;"></textarea>
                    <button class="primary" id="addTemplate" style="width: 100%; margin-top: 8px; padding: 10px;">–î–æ–±–∞–≤–∏—Ç—å —à–∞–±–ª–æ–Ω</button>
                </div>
            </div>
            
            <div class="modal-footer">
                <button id="closeTemplatesBtn">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        const defaultChecklist = [
            {
                id: 'section-1',
                title: '–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è',
                items: [
                    { id: 'title', text: '–ù–∞–ª–∏—á–∏–µ –æ—Å–Ω–æ–≤–Ω–æ–π –Ω–∞–¥–ø–∏—Å–∏ (—à—Ç–∞–º–ø–∞)' },
                    { id: 'project-name', text: '–£–∫–∞–∑–∞–Ω–æ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞' },
                    { id: 'scale', text: '–£–∫–∞–∑–∞–Ω –º–∞—Å—à—Ç–∞–± —á–µ—Ä—Ç–µ–∂–∞' },
                    { id: 'author', text: '–£–∫–∞–∑–∞–Ω—ã –∞–≤—Ç–æ—Ä –∏ –ø—Ä–æ–≤–µ—Ä—è—é—â–∏–π' }
                ]
            },
            {
                id: 'section-2',
                title: '–†–∞–∑–º–µ—Ä—ã –∏ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è',
                items: [
                    { id: 'dimensions', text: '–ü—Ä–æ—Å—Ç–∞–≤–ª–µ–Ω—ã –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Ä–∞–∑–º–µ—Ä—ã' },
                    { id: 'materials', text: '–£–∫–∞–∑–∞–Ω—ã –º–∞—Ç–µ—Ä–∏–∞–ª—ã –∏ –ø–æ–∫—Ä—ã—Ç–∏—è' },
                    { id: 'specification', text: '–°–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ–ª–Ω–∞—è –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è' },
                    { id: 'hardware', text: '–£–∫–∞–∑–∞–Ω–∞ –≤—Å—è —Ñ—É—Ä–Ω–∏—Ç—É—Ä–∞ –∏ –∫—Ä–µ–ø–µ–∂' }
                ]
            },
            {
                id: 'section-3',
                title: '–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è',
                items: [
                    { id: 'tech-requirements', text: '–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è —É–∫–∞–∑–∞–Ω—ã' },
                    { id: 'tolerances', text: '–£–∫–∞–∑–∞–Ω—ã –¥–æ–ø—É—Å–∫–∏ –∏ –ø–æ—Å–∞–¥–∫–∏' },
                    { id: 'finish', text: '–£–∫–∞–∑–∞–Ω–∞ —á–∏—Å—Ç–æ—Ç–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–µ–π' }
                ]
            },
            {
                id: 'section-4',
                title: '–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è',
                items: [
                    { id: 'views', text: '–í—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –≤–∏–¥—ã –∏ —Ä–∞–∑—Ä–µ–∑—ã' },
                    { id: 'sections', text: '–°–µ—á–µ–Ω–∏—è –æ–±–æ–∑–Ω–∞—á–µ–Ω—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ' },
                    { id: 'details', text: '–£–∑–ª—ã –∏ –¥–µ—Ç–∞–ª–∏ –ø–æ–∫–∞–∑–∞–Ω—ã –ø–æ–Ω—è—Ç–Ω–æ' }
                ]
            }
        ];

        let pdfDoc1 = null, pdfDoc2 = null, pageNum = 1, pageNum2 = 1, pageCount = 0, pageCount2 = 0, scale1 = 1.5, scale2 = 1.5, isDualView = false;
        let currentChecklist = [], checklistState = {}, isMobile = window.innerWidth <= 768;
        let isSyncEnabled = true; // Sync navigation by default

        const canvas1 = document.getElementById('canvas1');
        const canvas2 = document.getElementById('canvas2');
        const ctx1 = canvas1.getContext('2d');
        const ctx2 = canvas2.getContext('2d');
        const viewer1 = document.getElementById('viewer1');
        const viewer2 = document.getElementById('viewer2');
        const sidebar = document.getElementById('sidebar');
        const fab = document.getElementById('fab');
        const menuDropdown = document.getElementById('menuDropdown');

        window.addEventListener('resize', () => { isMobile = window.innerWidth <= 768; });

        document.getElementById('menuBtn').addEventListener('click', (e) => {
            e.stopPropagation();
            menuDropdown.classList.toggle('show');
            if (menuDropdown.classList.contains('show')) {
                fab.classList.add('rotated');
            } else {
                fab.classList.remove('rotated');
            }
        });

        document.addEventListener('click', (e) => {
            if (!menuDropdown.contains(e.target) && e.target.id !== 'menuBtn' && e.target.id !== 'fab') {
                menuDropdown.classList.remove('show');
                if (sidebar.classList.contains('collapsed')) {
                    fab.classList.remove('rotated');
                }
            }
        });

        document.getElementById('sidebarToggle').addEventListener('click', () => {
            sidebar.classList.toggle('collapsed');
            updatePdfContainerMargin();
            // Update FAB rotation based on sidebar state
            if (!sidebar.classList.contains('collapsed')) {
                fab.classList.add('rotated');
                menuDropdown.classList.remove('show');
            } else if (!menuDropdown.classList.contains('show')) {
                fab.classList.remove('rotated');
            }
        });

        document.getElementById('closeSidebar').addEventListener('click', () => {
            sidebar.classList.add('collapsed');
            updatePdfContainerMargin();
            if (!menuDropdown.classList.contains('show')) {
                fab.classList.remove('rotated');
            }
        });

        function updatePdfContainerMargin() {
            const pdfContainer = document.querySelector('.pdf-container');
            if (window.innerWidth > 768) {
                // Desktop mode
                if (sidebar.classList.contains('collapsed')) {
                    pdfContainer.classList.add('sidebar-hidden');
                } else {
                    pdfContainer.classList.remove('sidebar-hidden');
                }
            }
        }

        fab.addEventListener('click', (e) => {
            e.stopPropagation();
            const isMenuOpen = menuDropdown.classList.contains('show');
            const isSidebarOpen = !sidebar.classList.contains('collapsed');
            
            if (isMenuOpen || isSidebarOpen) {
                // Close everything
                menuDropdown.classList.remove('show');
                sidebar.classList.add('collapsed');
                fab.classList.remove('rotated');
            } else {
                // Open menu
                menuDropdown.classList.add('show');
                fab.classList.add('rotated');
            }
        });

        sidebar.addEventListener('transitionend', () => {
            if (!sidebar.classList.contains('collapsed')) {
                menuDropdown.classList.remove('show');
            }
        });

        document.getElementById('pdf1').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const fileReader = new FileReader();
                fileReader.onload = function() {
                    const typedarray = new Uint8Array(this.result);
                    pdfjsLib.getDocument(typedarray).promise.then(function(pdf) {
                        pdfDoc1 = pdf;
                        pageCount = pdf.numPages;
                        document.getElementById('pageCount').textContent = pageCount;
                        pageNum = 1;
                        renderPage(pageNum, pdfDoc1, canvas1, ctx1);
                        showToast('–û—Å–Ω–æ–≤–Ω–æ–π —á–µ—Ä—Ç–µ–∂ –∑–∞–≥—Ä—É–∂–µ–Ω');
                        menuDropdown.classList.remove('show');
                    });
                };
                fileReader.readAsArrayBuffer(file);
            }
        });

        document.getElementById('pdf2').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const fileReader = new FileReader();
                fileReader.onload = function() {
                    const typedarray = new Uint8Array(this.result);
                    pdfjsLib.getDocument(typedarray).promise.then(function(pdf) {
                        pdfDoc2 = pdf;
                        pageCount2 = pdf.numPages;
                        pageNum2 = 1;
                        if (isDualView) {
                            if (isSyncEnabled) {
                                pageNum2 = pageNum;
                            }
                            renderPage(pageNum2, pdfDoc2, canvas2, ctx2, true);
                        }
                        showToast('–î–æ–∫—É–º–µ–Ω—Ç –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω');
                        menuDropdown.classList.remove('show');
                    });
                };
                fileReader.readAsArrayBuffer(file);
            }
        });

        function renderPage(num, pdfDoc, canvas, ctx, isSecondViewer = false) {
            if (!pdfDoc) return;
            const currentScale = isSecondViewer ? scale2 : scale1;
            
            pdfDoc.getPage(num).then(function(page) {
                const viewport = page.getViewport({ scale: currentScale });
                canvas.height = viewport.height;
                canvas.width = viewport.width;
                page.render({ canvasContext: ctx, viewport: viewport }).promise.then(() => {
                    // Render annotation overlays after PDF is rendered
                    if (!isSecondViewer) {
                        renderAnnotationOverlays(canvas, currentPageAnnotations, viewport);
                    }
                });
                
                // Extract comments from page if it's the main viewer
                if (!isSecondViewer) {
                    extractPageComments(page, num);
                }
            });
            
            if (isSecondViewer) {
                document.getElementById('pageNum2Display').textContent = num;
                document.getElementById('pageCount2Display').textContent = pageCount2;
                document.getElementById('pageNum2DisplayMobile').textContent = num;
                document.getElementById('pageCount2DisplayMobile').textContent = pageCount2;
            } else {
                document.getElementById('pageNum').textContent = num;
            }
        }

        // Update overlays when scale changes
        function updateAnnotationOverlays() {
            if (!pdfDoc1 || !currentPageAnnotations.length) return;
            
            pdfDoc1.getPage(pageNum).then(function(page) {
                const viewport = page.getViewport({ scale: scale1 });
                renderAnnotationOverlays(canvas1, currentPageAnnotations, viewport);
            });
        }

        // Render annotation overlays on canvas
        function renderAnnotationOverlays(canvas, annotations, viewport) {
            // Remove existing overlays from this canvas
            const parent = canvas.parentElement;
            const existingOverlay = parent.querySelector('.annotation-overlay');
            if (existingOverlay) {
                existingOverlay.remove();
            }
            
            // Remove orphaned tooltips
            document.querySelectorAll('.annotation-tooltip').forEach(el => {
                if (!document.body.contains(el.previousElementSibling)) {
                    el.remove();
                }
            });

            // Exit if markers are disabled or no annotations
            if (!showAnnotationMarkers || !annotations || annotations.length === 0) return;

            // Create new overlay
            const overlay = document.createElement('div');
            overlay.className = 'annotation-overlay';
            overlay.style.width = canvas.width + 'px';
            overlay.style.height = canvas.height + 'px';

            // Add markers for each annotation with valid content
            annotations.forEach((comment, index) => {
                // Skip if no valid rect or no content
                if (!comment.rect || comment.rect.length < 4 || !comment.content) return;

                const [x1, y1, x2, y2] = comment.rect;
                
                // Convert PDF coordinates to canvas coordinates
                // Use convertToViewportPoint for precise conversion
                const canvasPoint1 = viewport.convertToViewportPoint(x1, y1);
                const canvasPoint2 = viewport.convertToViewportPoint(x2, y2);
                
                // Calculate bounding box
                const left = Math.min(canvasPoint1[0], canvasPoint2[0]);
                const top = Math.min(canvasPoint1[1], canvasPoint2[1]);
                const width = Math.abs(canvasPoint2[0] - canvasPoint1[0]);
                const height = Math.abs(canvasPoint2[1] - canvasPoint1[1]);

                const marker = document.createElement('div');
                marker.className = `annotation-marker ${comment.type.toLowerCase()}`;
                marker.style.left = left + 'px';
                marker.style.top = top + 'px';
                marker.dataset.annotationId = comment.rawAnnotation?.id || index;
                
                if (comment.type === 'Text') {
                    // Sticky note icon
                    marker.textContent = 'üí¨';
                    marker.style.width = '24px';
                    marker.style.height = '24px';
                } else if (comment.type === 'Highlight' || comment.type === 'Underline' || comment.type === 'StrikeOut') {
                    // Highlighted area
                    marker.style.width = Math.max(width, 10) + 'px';
                    marker.style.height = Math.max(height, 10) + 'px';
                }

                // Create tooltip
                const tooltip = document.createElement('div');
                tooltip.className = 'annotation-tooltip';
                tooltip.dataset.annotationId = comment.rawAnnotation?.id || index;
                
                if (comment.author) {
                    const authorDiv = document.createElement('div');
                    authorDiv.className = 'annotation-tooltip-author';
                    authorDiv.textContent = 'üë§ ' + comment.author;
                    tooltip.appendChild(authorDiv);
                }
                
                const contentDiv = document.createElement('div');
                contentDiv.className = 'annotation-tooltip-content';
                contentDiv.textContent = comment.content;
                tooltip.appendChild(contentDiv);

                const typeDiv = document.createElement('div');
                typeDiv.className = 'annotation-tooltip-type';
                const typeNames = {
                    'Highlight': 'üîÜ –í—ã–¥–µ–ª–µ–Ω–∏–µ',
                    'Text': 'üìå –ó–∞–º–µ—Ç–∫–∞',
                    'Underline': 'üìè –ü–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏–µ',
                    'StrikeOut': '‚ùå –ó–∞—á–µ—Ä–∫–∏–≤–∞–Ω–∏–µ'
                };
                typeDiv.textContent = typeNames[comment.type] || comment.type;
                tooltip.appendChild(typeDiv);

                document.body.appendChild(tooltip);

                // Show tooltip on hover
                marker.addEventListener('mouseenter', (e) => {
                    const rect = marker.getBoundingClientRect();
                    const tooltipWidth = 300; // max-width from CSS
                    let left = rect.left + rect.width / 2;
                    
                    // Keep tooltip within viewport
                    if (left + tooltipWidth / 2 > window.innerWidth) {
                        left = window.innerWidth - tooltipWidth / 2 - 10;
                    }
                    if (left - tooltipWidth / 2 < 0) {
                        left = tooltipWidth / 2 + 10;
                    }
                    
                    tooltip.style.left = left + 'px';
                    tooltip.style.top = (rect.bottom + 10) + 'px';
                    tooltip.style.transform = 'translateX(-50%)';
                    tooltip.classList.add('show');
                });

                marker.addEventListener('mouseleave', () => {
                    tooltip.classList.remove('show');
                });

                overlay.appendChild(marker);
            });

            // Ensure parent has relative positioning
            if (!parent.style.position || parent.style.position === 'static') {
                parent.style.position = 'relative';
            }
            parent.appendChild(overlay);
        }

        // Comments extraction
        let allComments = {};
        let currentPageAnnotations = [];
        let showAnnotationMarkers = false; // Default: markers are hidden

        // Workaround for PDF.js not decoding unicode Contents in annotations
        async function extractAnnotationContents(page, annotation) {
            try {
                // Try to access raw PDF object and extract actual string value
                
                // Method 1: Check contentsObj (it's a Name/Dict object, need to extract value)
                if (annotation.contentsObj) {
                    const obj = annotation.contentsObj;
                    console.log('contentsObj type:', typeof obj, obj);
                    
                    // If it's a Dict/Name object, try to get the actual string
                    if (obj.str) return obj.str;
                    if (obj.name) return obj.name;
                    if (obj.value) return String(obj.value);
                    if (typeof obj === 'string') return obj;
                    
                    // Try to call toString
                    if (obj.toString && obj.toString() !== '[object Object]') {
                        return obj.toString();
                    }
                }
                
                // Method 2: Try richText
                if (annotation.richText) {
                    return String(annotation.richText);
                }
                
                // Method 3: Return null
                return null;
            } catch (err) {
                console.error('Error in extractAnnotationContents:', err);
                return null;
            }
        }
        
        // Deep annotation reading from PDF internal structure
        async function readAnnotationData(page, annotationId) {
            try {
                const pdfPage = page;
                const annotationsDict = await pdfPage.getAnnotations({ intent: 'display' });
                
                // Try to access raw PDF objects
                const pageRef = pdfPage.ref;
                if (!pageRef) return null;
                
                // This is experimental - try to read annotation stream directly
                console.log('Trying deep read for annotation:', annotationId);
                
                return null; // Placeholder for now
            } catch (err) {
                console.error('Deep read failed:', err);
                return null;
            }
        }
        
        async function extractPageComments(page, pageNumber) {
            try {
                const annotations = await page.getAnnotations();
                const textContent = await page.getTextContent();
                currentPageAnnotations = [];
                
                console.log(`%cPage ${pageNumber}: Found ${annotations.length} annotations`, 'color: blue; font-weight: bold');
                
                // First pass: collect all annotations and build a map
                const annotationMap = {};
                for (const annotation of annotations) {
                    annotationMap[annotation.id] = annotation;
                }
                
                for (const annotation of annotations) {
                    // Log full annotation object for debugging
                    console.group(`Annotation ${annotation.id}`);
                    console.log('Type:', annotation.subtype);
                    console.log('Contents:', annotation.contents);
                    console.log('Title:', annotation.title);
                    console.log('Has popup:', annotation.popup);
                    console.log('All properties:', Object.keys(annotation));
                    console.groupEnd();
                    
                    // Skip link and popup annotations
                    if (annotation.subtype === 'Link' || annotation.subtype === 'Popup') continue;
                    
                    const comment = {
                        page: pageNumber,
                        type: annotation.subtype,
                        content: '',
                        author: annotation.title || annotation.userName || annotation.T || 'damli',
                        color: annotation.color || null,
                        rect: annotation.rect || null,
                        highlightedText: '',
                        rawAnnotation: annotation
                    };
                    
                    // Try to get contents from various sources
                    let commentText = '';
                    
                    // Try workaround method
                    const altContents = await extractAnnotationContents(page, annotation);
                    if (altContents && altContents !== '[object Object]') {
                        commentText = altContents;
                        console.log('%c‚úì Got contents from workaround method!', 'color: green', commentText);
                    } else if (altContents) {
                        console.warn('Got object instead of string:', altContents);
                        
                        // Try to extract from PDF.js internal structure
                        // contentsObj is a Name object - access internal properties
                        if (annotation.contentsObj) {
                            // Try accessing internal PDF.js Name properties
                            const obj = annotation.contentsObj;
                            
                            // PDF.js Name objects have internal properties
                            if (obj._name) commentText = obj._name;
                            else if (obj.name) commentText = obj.name;
                            else if (obj.str) commentText = obj.str;
                            else if (obj._str) commentText = obj._str;
                            else if (obj.value) commentText = obj.value;
                            
                            // Last resort: try to JSON stringify and extract
                            if (!commentText) {
                                try {
                                    const jsonStr = JSON.stringify(obj);
                                    console.log('JSON of contentsObj:', jsonStr);
                                } catch (e) {
                                    console.error('Cannot stringify contentsObj');
                                }
                            }
                            
                            if (commentText) {
                                console.log('%c‚úì‚úì Extracted from contentsObj!', 'color: green; font-weight: bold', commentText);
                            }
                        }
                    }
                    
                    // Try all possible content fields
                    if (!commentText) {
                        commentText = annotation.contents || 
                                    annotation.Contents ||
                                    annotation.contentsObj ||
                                    annotation.RC || // Rich text contents
                                    annotation.DS || // Default style string
                                    '';
                    }
                    
                    // Check if there's a linked popup annotation
                    if (!commentText && annotation.popup && annotationMap[annotation.popup]) {
                        const popupAnnotation = annotationMap[annotation.popup];
                        commentText = popupAnnotation.contents || popupAnnotation.Contents || '';
                        if (commentText) console.log('%c‚úì Found popup contents', 'color: green', commentText);
                    }
                    
                    // Check for reply structure
                    if (!commentText && annotation.inReplyTo && annotationMap[annotation.inReplyTo]) {
                        const parentAnnotation = annotationMap[annotation.inReplyTo];
                        commentText = parentAnnotation.contents || parentAnnotation.Contents || '';
                        if (commentText) console.log('%c‚úì Found reply contents', 'color: green', commentText);
                    }
                    
                    // Ensure commentText is a string
                    commentText = String(commentText || '');
                    
                    // Extract text content from the annotated region for context
                    if (['Highlight', 'Underline', 'StrikeOut', 'Squiggly'].includes(annotation.subtype)) {
                        const annotatedText = extractTextFromRect(textContent, annotation.rect);
                        if (annotatedText) {
                            comment.highlightedText = annotatedText;
                        }
                        
                        if (commentText.trim()) {
                            comment.content = commentText.trim();
                            console.log('%cüìù Final content:', 'color: purple', comment.content);
                        } else if (annotatedText) {
                            comment.content = `[–ë–µ–∑ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è]\n${annotatedText}`;
                        } else {
                            comment.content = '[–í—ã–¥–µ–ª–µ–Ω–∏–µ –±–µ–∑ —Ç–µ–∫—Å—Ç–∞]';
                        }
                    } else if (annotation.subtype === 'FreeText') {
                        comment.content = commentText || '[–ü—É—Å—Ç–æ–π —Ç–µ–∫—Å—Ç]';
                    } else if (annotation.subtype === 'Text') {
                        comment.content = commentText || '[–ó–∞–º–µ—Ç–∫–∞ –±–µ–∑ —Ç–µ–∫—Å—Ç–∞]';
                    } else if (annotation.subtype === 'Square' || annotation.subtype === 'Circle') {
                        comment.content = commentText || '[–§–∏–≥—É—Ä–∞ –±–µ–∑ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è]';
                    } else if (annotation.subtype === 'Ink') {
                        comment.content = commentText || '[–†–∏—Å—É–Ω–æ–∫]';
                    } else {
                        comment.content = commentText || `[${annotation.subtype}]`;
                    }
                    
                    currentPageAnnotations.push(comment);
                    if (!allComments[pageNumber]) {
                        allComments[pageNumber] = [];
                    }
                    allComments[pageNumber].push(comment);
                }
                
                console.log(`%c‚úÖ Page ${pageNumber}: Extracted ${currentPageAnnotations.length} comments`, 'color: green; font-weight: bold');
                updateCommentsDisplay();
            } catch (err) {
                console.error('Error extracting comments:', err);
                showToast('‚ùå –û—à–∏–±–∫–∞: ' + err.message);
            }
        }

        function extractTextFromRect(textContent, rect) {
            if (!rect || rect.length !== 4) return null;
            
            const [x1, y1, x2, y2] = rect;
            const minX = Math.min(x1, x2);
            const maxX = Math.max(x1, x2);
            const minY = Math.min(y1, y2);
            const maxY = Math.max(y1, y2);
            
            let extractedText = '';
            
            textContent.items.forEach(item => {
                const itemX = item.transform[4];
                const itemY = item.transform[5];
                
                // Check if text item is within annotation bounds (with some tolerance)
                const tolerance = 5;
                if (itemX >= minX - tolerance && itemX <= maxX + tolerance &&
                    itemY >= minY - tolerance && itemY <= maxY + tolerance) {
                    extractedText += item.str;
                }
            });
            
            return extractedText.trim();
        }

        function updateCommentsDisplay() {
            const commentsList = document.getElementById('commentsList');
            const commentsCount = document.getElementById('commentsCount');
            const currentPageComments = document.getElementById('currentPageComments');
            
            currentPageComments.textContent = pageNum;
            commentsCount.textContent = currentPageAnnotations.length;
            
            if (currentPageAnnotations.length === 0) {
                commentsList.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üí¨</div><p>–ù–∞ —ç—Ç–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ –Ω–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤</p></div>';
                return;
            }
            
            commentsList.innerHTML = currentPageAnnotations.map((comment, i) => {
                const typeNames = {
                    'FreeText': '–¢–µ–∫—Å—Ç',
                    'Text': '–ó–∞–º–µ—Ç–∫–∞',
                    'Highlight': '–í—ã–¥–µ–ª–µ–Ω–∏–µ',
                    'Underline': '–ü–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏–µ',
                    'StrikeOut': '–ó–∞—á–µ—Ä–∫–∏–≤–∞–Ω–∏–µ',
                    'Squiggly': '–í–æ–ª–Ω–∏—Å—Ç–æ–µ',
                    'Square': '–ü—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫',
                    'Circle': '–ö—Ä—É–≥',
                    'Ink': '–†–∏—Å—É–Ω–æ–∫',
                    'Stamp': '–®—Ç–∞–º–ø'
                };
                
                let contentHtml = '';
                
                // Show manager's comment (annotation.contents)
                if (comment.content) {
                    contentHtml = `<div style="margin-bottom: 8px;">${comment.content}</div>`;
                }
                
                // Show highlighted text as context if different from comment
                if (comment.highlightedText && comment.highlightedText !== comment.content) {
                    contentHtml += `<div style="font-size: 12px; color: var(--text-tertiary); border-left: 2px solid var(--accent); padding-left: 8px; margin-top: 6px;">üìç –ö–æ–Ω—Ç–µ–∫—Å—Ç: "${comment.highlightedText}"</div>`;
                }
                
                return `
                    <div class="comment-item">
                        <div class="comment-header">
                            <span class="comment-type">${typeNames[comment.type] || comment.type}</span>
                            <span class="comment-page">–°—Ç—Ä. ${comment.page}</span>
                        </div>
                        <div class="comment-content">${contentHtml}</div>
                        ${comment.author ? `<div class="comment-author">üë§ ${comment.author}</div>` : ''}
                    </div>
                `;
            }).join('');
        }

        async function extractAllCommentsFromPDF() {
            if (!pdfDoc1) {
                showToast('‚ùå –ó–∞–≥—Ä—É–∑–∏—Ç–µ PDF');
                return;
            }
            
            allComments = {};
            showToast('‚è≥ –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤...');
            
            try {
                for (let i = 1; i <= pageCount; i++) {
                    const page = await pdfDoc1.getPage(i);
                    const annotations = await page.getAnnotations();
                    const textContent = await page.getTextContent();
                    
                    for (const annotation of annotations) {
                        if (annotation.subtype === 'Link') continue;
                        
                        const comment = {
                            page: i,
                            type: annotation.subtype,
                            content: '',
                            author: annotation.title || '',
                            highlightedText: ''
                        };
                        
                        // Extract text content from the annotated region for context
                        if (['Highlight', 'Underline', 'StrikeOut', 'Squiggly'].includes(annotation.subtype)) {
                            const annotatedText = extractTextFromRect(textContent, annotation.rect);
                            if (annotatedText) {
                                comment.highlightedText = annotatedText;
                            }
                            
                            // PRIORITY: annotation.contents is the actual comment
                            if (annotation.contents && annotation.contents.trim()) {
                                comment.content = annotation.contents.trim();
                            } else if (annotatedText) {
                                comment.content = annotatedText;
                            } else {
                                comment.content = '–í—ã–¥–µ–ª–µ–Ω–∏–µ';
                            }
                        } else if (annotation.subtype === 'FreeText') {
                            comment.content = annotation.contents || '';
                        } else if (annotation.subtype === 'Text') {
                            comment.content = annotation.contents || '–ó–∞–º–µ—Ç–∫–∞';
                        } else if (annotation.subtype === 'Square' || annotation.subtype === 'Circle') {
                            comment.content = annotation.contents || '–ì–µ–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∞—è –º–µ—Ç–∫–∞';
                        } else if (annotation.subtype === 'Ink') {
                            comment.content = annotation.contents || '–†–∏—Å—É–Ω–æ–∫/—Å—Ç—Ä–µ–ª–∫–∞';
                        } else {
                            comment.content = annotation.contents || '–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π';
                        }
                        
                        if (comment.content) {
                            if (!allComments[i]) {
                                allComments[i] = [];
                            }
                            allComments[i].push(comment);
                        }
                    }
                }
                
                displayAllComments();
                showToast('‚úÖ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∏–∑–≤–ª–µ—á–µ–Ω—ã');
            } catch (err) {
                showToast('‚ùå –û—à–∏–±–∫–∞ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è');
                console.error(err);
            }
        }

        function displayAllComments() {
            const commentsList = document.getElementById('commentsList');
            const totalComments = Object.values(allComments).reduce((sum, arr) => sum + arr.length, 0);
            
            document.getElementById('commentsCount').textContent = totalComments;
            document.getElementById('currentPageComments').textContent = '–í—Å–µ';
            
            if (totalComments === 0) {
                commentsList.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üí¨</div><p>–í –¥–æ–∫—É–º–µ–Ω—Ç–µ –Ω–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤</p></div>';
                return;
            }
            
            let html = '';
            for (let pageNum in allComments) {
                allComments[pageNum].forEach(comment => {
                    const typeNames = {
                        'FreeText': '–¢–µ–∫—Å—Ç',
                        'Text': '–ó–∞–º–µ—Ç–∫–∞',
                        'Highlight': '–í—ã–¥–µ–ª–µ–Ω–∏–µ',
                        'Underline': '–ü–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏–µ',
                        'StrikeOut': '–ó–∞—á–µ—Ä–∫–∏–≤–∞–Ω–∏–µ',
                        'Squiggly': '–í–æ–ª–Ω–∏—Å—Ç–æ–µ',
                        'Square': '–ü—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫',
                        'Circle': '–ö—Ä—É–≥',
                        'Ink': '–†–∏—Å—É–Ω–æ–∫',
                        'Stamp': '–®—Ç–∞–º–ø'
                    };
                    
                    let contentHtml = '';
                    
                    // Show manager's comment first
                    if (comment.content) {
                        contentHtml = `<div style="margin-bottom: 8px;">${comment.content}</div>`;
                    }
                    
                    // Show highlighted text as context if different
                    if (comment.highlightedText && comment.highlightedText !== comment.content) {
                        contentHtml += `<div style="font-size: 12px; color: var(--text-tertiary); border-left: 2px solid var(--accent); padding-left: 8px; margin-top: 6px;">üìç –ö–æ–Ω—Ç–µ–∫—Å—Ç: "${comment.highlightedText}"</div>`;
                    }
                    
                    html += `
                        <div class="comment-item">
                            <div class="comment-header">
                                <span class="comment-type">${typeNames[comment.type] || comment.type}</span>
                                <span class="comment-page">–°—Ç—Ä. ${comment.page}</span>
                            </div>
                            <div class="comment-content">${contentHtml}</div>
                            ${comment.author ? `<div class="comment-author">üë§ ${comment.author}</div>` : ''}
                        </div>
                    `;
                });
            }
            
            commentsList.innerHTML = html;
        }

        document.getElementById('extractAllComments').addEventListener('click', extractAllCommentsFromPDF);

        document.getElementById('copyComments').addEventListener('click', () => {
            const totalComments = Object.values(allComments).reduce((sum, arr) => sum + arr.length, 0);
            
            if (totalComments === 0) {
                showToast('‚ùå –ù–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤');
                return;
            }
            
            let text = 'üìù –ö–û–ú–ú–ï–ù–¢–ê–†–ò–ò –ò–ó PDF\n\n';
            
            if (productName.value || productArticle.value) {
                if (productName.value) text += `–ò–∑–¥–µ–ª–∏–µ: ${productName.value}\n`;
                if (productArticle.value) text += `–ê—Ä—Ç–∏–∫—É–ª: ${productArticle.value}\n`;
                text += '\n';
            }
            
            const now = new Date();
            text += `–î–∞—Ç–∞: ${now.toLocaleDateString('ru-RU')}, ${now.toLocaleTimeString('ru-RU', {hour: '2-digit', minute: '2-digit'})}\n`;
            text += `–í—Å–µ–≥–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤: ${totalComments}\n\n`;
            text += '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n';
            
            for (let pageNum in allComments) {
                text += `üìÑ –°—Ç—Ä–∞–Ω–∏—Ü–∞ ${pageNum}:\n\n`;
                allComments[pageNum].forEach((comment, i) => {
                    text += `${i + 1}. ${comment.content}\n`;
                    if (comment.author) text += `   –ê–≤—Ç–æ—Ä: ${comment.author}\n`;
                    text += '\n';
                });
                text += '\n';
            }
            
            navigator.clipboard.writeText(text).then(() => {
                showToast('‚úÖ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã');
            });
        });

        document.getElementById('exportComments').addEventListener('click', () => {
            const totalComments = Object.values(allComments).reduce((sum, arr) => sum + arr.length, 0);
            
            if (totalComments === 0) {
                showToast('‚ùå –ù–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤');
                return;
            }
            
            let text = '=== –ö–û–ú–ú–ï–ù–¢–ê–†–ò–ò –ò–ó PDF ===\n\n';
            
            if (productName.value || productArticle.value) {
                if (productName.value) text += `–ò–∑–¥–µ–ª–∏–µ: ${productName.value}\n`;
                if (productArticle.value) text += `–ê—Ä—Ç–∏–∫—É–ª: ${productArticle.value}\n`;
                text += '\n';
            }
            
            const now = new Date();
            text += `–î–∞—Ç–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞: ${now.toLocaleDateString('ru-RU')}, ${now.toLocaleTimeString('ru-RU')}\n`;
            text += `–í—Å–µ–≥–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤: ${totalComments}\n\n`;
            text += '========================================\n\n';
            
            for (let pageNum in allComments) {
                text += `–°–¢–†–ê–ù–ò–¶–ê ${pageNum}\n\n`;
                allComments[pageNum].forEach((comment, i) => {
                    text += `${i + 1}. ${comment.content}\n`;
                    if (comment.author) text += `   –ê–≤—Ç–æ—Ä: ${comment.author}\n`;
                    text += '\n';
                });
                text += '\n';
            }
            
            const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `comments_${new Date().toISOString().split('T')[0]}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('üíæ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã');
        });


        document.getElementById('prevPage').addEventListener('click', () => {
            if (pageNum <= 1) return;
            pageNum--;
            if (pdfDoc1) renderPage(pageNum, pdfDoc1, canvas1, ctx1);
            
            if (pdfDoc2 && isDualView && isSyncEnabled) {
                if (pageNum2 > 1) {
                    pageNum2--;
                    renderPage(pageNum2, pdfDoc2, canvas2, ctx2, true);
                }
            }
        });

        document.getElementById('nextPage').addEventListener('click', () => {
            if (pageNum >= pageCount) return;
            pageNum++;
            if (pdfDoc1) renderPage(pageNum, pdfDoc1, canvas1, ctx1);
            
            if (pdfDoc2 && isDualView && isSyncEnabled) {
                if (pageNum2 < pageCount2) {
                    pageNum2++;
                    renderPage(pageNum2, pdfDoc2, canvas2, ctx2, true);
                }
            }
        });

        // Zoom controls for document 1
        const zoomSlider1 = document.getElementById('zoomSlider1');
        const zoomSelect1 = document.getElementById('zoomSelect1');

        zoomSlider1.addEventListener('input', () => {
            scale1 = parseInt(zoomSlider1.value) / 100;
            zoomSelect1.value = zoomSlider1.value;
            if (pdfDoc1) {
                renderPage(pageNum, pdfDoc1, canvas1, ctx1);
            }
        });

        zoomSelect1.addEventListener('change', () => {
            scale1 = parseInt(zoomSelect1.value) / 100;
            zoomSlider1.value = zoomSelect1.value;
            if (pdfDoc1) {
                renderPage(pageNum, pdfDoc1, canvas1, ctx1);
            }
        });

        // Zoom controls for document 2
        const zoomSlider2 = document.getElementById('zoomSlider2');
        const zoomSelect2 = document.getElementById('zoomSelect2');
        const zoomSlider2Mobile = document.getElementById('zoomSlider2Mobile');
        const zoomSelect2Mobile = document.getElementById('zoomSelect2Mobile');

        function updateZoom2(value) {
            scale2 = parseInt(value) / 100;
            zoomSelect2.value = value;
            zoomSlider2.value = value;
            zoomSelect2Mobile.value = value;
            zoomSlider2Mobile.value = value;
            if (pdfDoc2 && isDualView) renderPage(pageNum2, pdfDoc2, canvas2, ctx2, true);
        }

        zoomSlider2.addEventListener('input', () => {
            updateZoom2(zoomSlider2.value);
        });

        zoomSelect2.addEventListener('change', () => {
            updateZoom2(zoomSelect2.value);
        });

        zoomSlider2Mobile.addEventListener('input', () => {
            updateZoom2(zoomSlider2Mobile.value);
        });

        zoomSelect2Mobile.addEventListener('change', () => {
            updateZoom2(zoomSelect2Mobile.value);
        });

        document.getElementById('singleViewBtn').addEventListener('click', () => {
            isDualView = false;
            viewer2.classList.add('hidden');
            document.getElementById('syncToggle').style.display = 'none';
            document.getElementById('zoomControls2').style.display = 'none';
            document.getElementById('secondControlsWrapper').classList.remove('show');
            showToast('–†–µ–∂–∏–º –æ–¥–Ω–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞');
            menuDropdown.classList.remove('show');
        });

        // Sync toggle
        const syncToggle = document.getElementById('syncToggle');
        const viewer2Controls = document.getElementById('viewer2Controls');
        
        function updateSyncButton() {
            if (isSyncEnabled) {
                syncToggle.textContent = 'üîó';
                syncToggle.title = '–°–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è (–ª–∏—Å—Ç–∞—Ç—å –≤–º–µ—Å—Ç–µ)';
                syncToggle.style.opacity = '1';
                viewer2Controls.style.display = 'none';
            } else {
                syncToggle.textContent = '‚õìÔ∏è‚Äçüí•';
                syncToggle.title = '–ù–µ–∑–∞–≤–∏—Å–∏–º–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è (–ª–∏—Å—Ç–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω–æ)';
                syncToggle.style.opacity = '0.6';
                if (isDualView && pdfDoc2) {
                    viewer2Controls.style.display = 'flex';
                }
            }
        }
        
        updateSyncButton();
        
        syncToggle.addEventListener('click', () => {
            isSyncEnabled = !isSyncEnabled;
            updateSyncButton();
            
            if (isSyncEnabled) {
                // Sync to current page of first document
                pageNum2 = pageNum;
                if (pdfDoc2 && isDualView) {
                    renderPage(pageNum2, pdfDoc2, canvas2, ctx2, true);
                }
                showToast('–°–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è');
            } else {
                showToast('–ù–µ–∑–∞–≤–∏—Å–∏–º–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è');
            }
        });

        // Navigation buttons for second viewer
        document.getElementById('prevPage2').addEventListener('click', () => {
            if (!pdfDoc2 || pageNum2 <= 1) return;
            pageNum2--;
            renderPage(pageNum2, pdfDoc2, canvas2, ctx2, true);
            updatePage2Display();
        });

        document.getElementById('nextPage2').addEventListener('click', () => {
            if (!pdfDoc2 || pageNum2 >= pageCount2) return;
            pageNum2++;
            renderPage(pageNum2, pdfDoc2, canvas2, ctx2, true);
            updatePage2Display();
        });

        // Mobile navigation buttons for second viewer
        document.getElementById('prevPage2Mobile').addEventListener('click', () => {
            if (!pdfDoc2 || pageNum2 <= 1) return;
            pageNum2--;
            renderPage(pageNum2, pdfDoc2, canvas2, ctx2, true);
            updatePage2Display();
        });

        document.getElementById('nextPage2Mobile').addEventListener('click', () => {
            if (!pdfDoc2 || pageNum2 >= pageCount2) return;
            pageNum2++;
            renderPage(pageNum2, pdfDoc2, canvas2, ctx2, true);
            updatePage2Display();
        });

        function updatePage2Display() {
            document.getElementById('pageNum2Display').textContent = pageNum2;
            document.getElementById('pageCount2Display').textContent = pageCount2;
            document.getElementById('pageNum2DisplayMobile').textContent = pageNum2;
            document.getElementById('pageCount2DisplayMobile').textContent = pageCount2;
        }

        // Add scroll/swipe navigation for second viewer when not synced
        // Add scroll/swipe navigation for first viewer
        canvas1.parentElement.addEventListener('wheel', (e) => {
            if (pdfDoc1) {
                e.preventDefault();
                
                if (e.deltaY < 0 && pageNum > 1) {
                    // Scroll up - previous page
                    pageNum--;
                    renderPage(pageNum, pdfDoc1, canvas1, ctx1);
                    if (isSyncEnabled && isDualView && pdfDoc2) {
                        pageNum2 = pageNum;
                        renderPage(pageNum2, pdfDoc2, canvas2, ctx2, true);
                    }
                } else if (e.deltaY > 0 && pageNum < pageCount) {
                    // Scroll down - next page
                    pageNum++;
                    renderPage(pageNum, pdfDoc1, canvas1, ctx1);
                    if (isSyncEnabled && isDualView && pdfDoc2) {
                        pageNum2 = pageNum;
                        renderPage(pageNum2, pdfDoc2, canvas2, ctx2, true);
                    }
                }
            }
        });

        // Add touch navigation for first viewer
        let touchStartY1 = 0;
        canvas1.parentElement.addEventListener('touchstart', (e) => {
            if (pdfDoc1) {
                touchStartY1 = e.touches[0].clientY;
            }
        });

        canvas1.parentElement.addEventListener('touchend', (e) => {
            if (pdfDoc1) {
                const touchEndY = e.changedTouches[0].clientY;
                const diff = touchStartY1 - touchEndY;
                
                if (Math.abs(diff) > 50) { // Minimum swipe distance
                    if (diff > 0 && pageNum < pageCount) {
                        // Swipe up - next page
                        pageNum++;
                        renderPage(pageNum, pdfDoc1, canvas1, ctx1);
                        if (isSyncEnabled && isDualView && pdfDoc2) {
                            pageNum2 = pageNum;
                            renderPage(pageNum2, pdfDoc2, canvas2, ctx2, true);
                        }
                    } else if (diff < 0 && pageNum > 1) {
                        // Swipe down - previous page
                        pageNum--;
                        renderPage(pageNum, pdfDoc1, canvas1, ctx1);
                        if (isSyncEnabled && isDualView && pdfDoc2) {
                            pageNum2 = pageNum;
                            renderPage(pageNum2, pdfDoc2, canvas2, ctx2, true);
                        }
                    }
                }
            }
        });

        canvas2.parentElement.addEventListener('wheel', (e) => {
            if (!isSyncEnabled && isDualView && pdfDoc2) {
                e.preventDefault();
                
                if (e.deltaY < 0 && pageNum2 > 1) {
                    // Scroll up - previous page
                    pageNum2--;
                    renderPage(pageNum2, pdfDoc2, canvas2, ctx2, true);
                } else if (e.deltaY > 0 && pageNum2 < pageCount2) {
                    // Scroll down - next page
                    pageNum2++;
                    renderPage(pageNum2, pdfDoc2, canvas2, ctx2, true);
                }
            }
        });

        // Add touch navigation for second viewer
        let touchStartY = 0;
        canvas2.parentElement.addEventListener('touchstart', (e) => {
            if (!isSyncEnabled && isDualView) {
                touchStartY = e.touches[0].clientY;
            }
        });

        canvas2.parentElement.addEventListener('touchend', (e) => {
            if (!isSyncEnabled && isDualView && pdfDoc2) {
                const touchEndY = e.changedTouches[0].clientY;
                const diff = touchStartY - touchEndY;
                
                if (Math.abs(diff) > 50) { // Minimum swipe distance
                    if (diff > 0 && pageNum2 < pageCount2) {
                        // Swipe up - next page
                        pageNum2++;
                        renderPage(pageNum2, pdfDoc2, canvas2, ctx2, true);
                    } else if (diff < 0 && pageNum2 > 1) {
                        // Swipe down - previous page
                        pageNum2--;
                        renderPage(pageNum2, pdfDoc2, canvas2, ctx2, true);
                    }
                }
            }
        });

        document.getElementById('dualViewBtn').addEventListener('click', () => {
            if (!pdfDoc2) {
                showToast('–ó–∞–≥—Ä—É–∑–∏—Ç–µ –≤—Ç–æ—Ä–æ–π –¥–æ–∫—É–º–µ–Ω—Ç');
                return;
            }
            isDualView = true;
            viewer2.classList.remove('hidden');
            document.getElementById('syncToggle').style.display = 'flex';
            document.getElementById('zoomControls2').style.display = 'flex';
            
            // Show mobile controls wrapper ONLY in portrait mode
            if (window.innerWidth <= 768 && window.matchMedia('(orientation: portrait)').matches) {
                document.getElementById('secondControlsWrapper').classList.add('show');
            }
            
            if (isSyncEnabled) {
                pageNum2 = pageNum;
            }
            renderPage(pageNum2, pdfDoc2, canvas2, ctx2, true);
            showToast('–†–µ–∂–∏–º —Å—Ä–∞–≤–Ω–µ–Ω–∏—è');
            menuDropdown.classList.remove('show');
        });

        let isDarkTheme = localStorage.getItem('theme') === 'dark';
        
        function applyTheme() {
            document.body.setAttribute('data-theme', isDarkTheme ? 'dark' : 'light');
            document.getElementById('themeIcon').textContent = isDarkTheme ? '‚òÄÔ∏è' : 'üåô';
            document.getElementById('themeText').textContent = isDarkTheme ? '–°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞' : '–¢—ë–º–Ω–∞—è —Ç–µ–º–∞';
        }
        
        applyTheme();
        
        document.getElementById('themeToggleBtn').addEventListener('click', () => {
            isDarkTheme = !isDarkTheme;
            localStorage.setItem('theme', isDarkTheme ? 'dark' : 'light');
            applyTheme();
            menuDropdown.classList.remove('show');
        });

        document.querySelectorAll('.sidebar-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                const targetTab = this.dataset.tab;
                document.querySelectorAll('.sidebar-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
                this.classList.add('active');
                document.getElementById(targetTab).classList.add('active');
            });
        });

        function loadChecklistData() {
            const saved = localStorage.getItem('checklistData');
            currentChecklist = saved ? JSON.parse(saved) : JSON.parse(JSON.stringify(defaultChecklist));
        }

        function saveChecklistData() {
            localStorage.setItem('checklistData', JSON.stringify(currentChecklist));
        }

        function renderChecklist() {
            const container = document.getElementById('checklist');
            container.innerHTML = '<h2>–ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä—Ç–µ–∂–∞</h2>';
            
            currentChecklist.forEach(section => {
                const sectionDiv = document.createElement('div');
                sectionDiv.className = 'checklist-section';
                
                const title = document.createElement('h3');
                title.textContent = section.title;
                sectionDiv.appendChild(title);
                
                section.items.forEach(item => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'checklist-item';
                    if (checklistState[item.id]) itemDiv.classList.add('checked');
                    
                    const label = document.createElement('label');
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.dataset.item = item.id;
                    checkbox.checked = checklistState[item.id] || false;
                    
                    checkbox.addEventListener('change', function() {
                        itemDiv.classList.toggle('checked', this.checked);
                        saveChecklistState();
                    });
                    
                    const span = document.createElement('span');
                    span.textContent = item.text;
                    
                    label.appendChild(checkbox);
                    label.appendChild(span);
                    itemDiv.appendChild(label);
                    sectionDiv.appendChild(itemDiv);
                });
                
                container.appendChild(sectionDiv);
            });
        }

        const editorModal = document.getElementById('editorModal');
        const editorSections = document.getElementById('editorSections');
        let editingChecklist = [];

        document.getElementById('editChecklistBtn').addEventListener('click', () => {
            openEditor();
            menuDropdown.classList.remove('show');
        });

        document.getElementById('closeModal').addEventListener('click', closeEditor);
        document.getElementById('cancelEdit').addEventListener('click', closeEditor);
        editorModal.addEventListener('click', (e) => { if (e.target === editorModal) closeEditor(); });

        function openEditor() {
            editingChecklist = JSON.parse(JSON.stringify(currentChecklist));
            renderEditor();
            editorModal.classList.add('show');
        }

        function closeEditor() {
            editorModal.classList.remove('show');
        }

        function renderEditor() {
            editorSections.innerHTML = '';
            
            editingChecklist.forEach((section, sectionIndex) => {
                const sectionDiv = document.createElement('div');
                sectionDiv.className = 'editor-section';
                
                const header = document.createElement('div');
                header.className = 'editor-section-header';
                
                const titleInput = document.createElement('input');
                titleInput.type = 'text';
                titleInput.value = section.title;
                titleInput.placeholder = '–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–∞';
                titleInput.addEventListener('input', function() {
                    editingChecklist[sectionIndex].title = this.value;
                });
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'destructive icon-only';
                deleteBtn.textContent = 'üóëÔ∏è';
                deleteBtn.addEventListener('click', () => {
                    if (confirm('–£–¥–∞–ª–∏—Ç—å —Ä–∞–∑–¥–µ–ª "' + section.title + '"?')) {
                        editingChecklist.splice(sectionIndex, 1);
                        renderEditor();
                    }
                });
                
                header.appendChild(titleInput);
                header.appendChild(deleteBtn);
                sectionDiv.appendChild(header);
                
                section.items.forEach((item, itemIndex) => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'editor-item';
                    
                    const itemInput = document.createElement('input');
                    itemInput.type = 'text';
                    itemInput.value = item.text;
                    itemInput.placeholder = '–¢–µ–∫—Å—Ç –ø—É–Ω–∫—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏';
                    itemInput.addEventListener('input', function() {
                        editingChecklist[sectionIndex].items[itemIndex].text = this.value;
                    });
                    
                    const deleteItemBtn = document.createElement('button');
                    deleteItemBtn.className = 'destructive icon-only';
                    deleteItemBtn.textContent = '‚úï';
                    deleteItemBtn.addEventListener('click', () => {
                        editingChecklist[sectionIndex].items.splice(itemIndex, 1);
                        renderEditor();
                    });
                    
                    itemDiv.appendChild(itemInput);
                    itemDiv.appendChild(deleteItemBtn);
                    sectionDiv.appendChild(itemDiv);
                });
                
                const addItemBtn = document.createElement('button');
                addItemBtn.className = 'primary';
                addItemBtn.textContent = '+ –î–æ–±–∞–≤–∏—Ç—å –ø—É–Ω–∫—Ç';
                addItemBtn.style.width = '100%';
                addItemBtn.style.marginTop = '8px';
                addItemBtn.addEventListener('click', () => {
                    editingChecklist[sectionIndex].items.push({
                        id: 'item-' + Date.now(),
                        text: ''
                    });
                    renderEditor();
                });
                
                sectionDiv.appendChild(addItemBtn);
                editorSections.appendChild(sectionDiv);
            });

            const addSectionBtn = document.createElement('button');
            addSectionBtn.className = 'primary';
            addSectionBtn.textContent = '+ –î–æ–±–∞–≤–∏—Ç—å —Ä–∞–∑–¥–µ–ª';
            addSectionBtn.style.width = '100%';
            addSectionBtn.addEventListener('click', () => {
                editingChecklist.push({
                    id: 'section-' + Date.now(),
                    title: '–ù–æ–≤—ã–π —Ä–∞–∑–¥–µ–ª',
                    items: []
                });
                renderEditor();
            });
            editorSections.appendChild(addSectionBtn);
        }

        document.getElementById('saveChecklist').addEventListener('click', () => {
            let hasEmptySections = false;
            editingChecklist.forEach(section => {
                if (!section.title.trim()) hasEmptySections = true;
                section.items = section.items.filter(item => item.text.trim() !== '');
            });
            
            if (hasEmptySections) {
                showToast('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏—è –≤—Å–µ—Ö —Ä–∞–∑–¥–µ–ª–æ–≤');
                return;
            }
            
            editingChecklist = editingChecklist.filter(section => section.items.length > 0);
            
            if (editingChecklist.length === 0) {
                showToast('–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Ä–∞–∑–¥–µ–ª');
                return;
            }
            
            currentChecklist = editingChecklist;
            saveChecklistData();
            renderChecklist();
            closeEditor();
            showToast('–û–ø—Ä–æ—Å–Ω–∏–∫ —Å–æ—Ö—Ä–∞–Ω—ë–Ω');
        });

        document.getElementById('resetChecklist').addEventListener('click', () => {
            if (confirm('–í–µ—Ä–Ω—É—Ç—å –æ–ø—Ä–æ—Å–Ω–∏–∫ –∫ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é?')) {
                editingChecklist = JSON.parse(JSON.stringify(defaultChecklist));
                renderEditor();
                showToast('–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –æ–ø—Ä–æ—Å–Ω–∏–∫ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é');
            }
        });

        // Annotation markers visibility toggle
        const showAnnotationMarkersCheckbox = document.getElementById('showAnnotationMarkers');
        
        // Load saved state
        showAnnotationMarkers = localStorage.getItem('showAnnotationMarkers') === 'true';
        showAnnotationMarkersCheckbox.checked = showAnnotationMarkers;
        
        // Handle checkbox change
        showAnnotationMarkersCheckbox.addEventListener('change', () => {
            showAnnotationMarkers = showAnnotationMarkersCheckbox.checked;
            localStorage.setItem('showAnnotationMarkers', showAnnotationMarkers);
            
            // Re-render current page to show/hide markers
            if (pdfDoc1) {
                renderPage(pageNum, pdfDoc1, canvas1, ctx1);
            }
            
            showToast(showAnnotationMarkers ? '‚úì –ú–∞—Ä–∫–µ—Ä—ã –ø–æ–∫–∞–∑–∞–Ω—ã' : '‚úó –ú–∞—Ä–∫–µ—Ä—ã —Å–∫—Ä—ã—Ç—ã');
        });

        function saveChecklistState() {
            const state = {};
            document.querySelectorAll('.checklist-item input[type="checkbox"]').forEach(checkbox => {
                state[checkbox.dataset.item] = checkbox.checked;
            });
            checklistState = state;
            localStorage.setItem('checklistState', JSON.stringify(state));
        }

        function loadChecklistState() {
            checklistState = JSON.parse(localStorage.getItem('checklistState') || '{}');
        }

        document.getElementById('copyNotes').addEventListener('click', () => {
            const fullText = getChecklistSummary() + '\n\n' + document.getElementById('notesText').value;
            navigator.clipboard.writeText(fullText).then(() => showToast('–¢–µ–∫—Å—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω'));
        });

        document.getElementById('exportNotes').addEventListener('click', () => {
            const fullText = getChecklistSummary() + '\n\n' + document.getElementById('notesText').value;
            const blob = new Blob([fullText], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `–ø—Ä–æ–≤–µ—Ä–∫–∞-—á–µ—Ä—Ç–µ–∂–∞-${new Date().toISOString().split('T')[0]}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('–§–∞–π–ª —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω');
        });

        function getChecklistSummary() {
            let summary = '=== –ü–†–û–í–ï–†–ö–ê –ß–ï–†–¢–ï–ñ–ê ===\n';
            summary += `–î–∞—Ç–∞: ${new Date().toLocaleString('ru-RU')}\n\n`;
            
            currentChecklist.forEach(section => {
                summary += `${section.title}\n`;
                section.items.forEach(item => {
                    const status = checklistState[item.id] ? '‚úì' : '‚úó';
                    summary += `  ${status} ${item.text}\n`;
                });
                summary += '\n';
            });
            
            const checkedCount = Object.values(checklistState).filter(v => v).length;
            const totalCount = currentChecklist.reduce((sum, section) => sum + section.items.length, 0);
            summary += `–í—ã–ø–æ–ª–Ω–µ–Ω–æ: ${checkedCount} –∏–∑ ${totalCount}\n`;
            summary += '='.repeat(40);
            
            return summary;
        }

        const notesText = document.getElementById('notesText');
        notesText.addEventListener('input', function() {
            localStorage.setItem('drawingNotes', this.value);
        });

        const savedNotes = localStorage.getItem('drawingNotes');
        if (savedNotes) notesText.value = savedNotes;

        // Product info fields
        const productName = document.getElementById('productName');
        const productArticle = document.getElementById('productArticle');
        
        const savedProduct = localStorage.getItem('currentProduct');
        if (savedProduct) {
            const product = JSON.parse(savedProduct);
            productName.value = product.name || '';
            productArticle.value = product.article || '';
        }

        productName.addEventListener('input', () => {
            localStorage.setItem('currentProduct', JSON.stringify({
                name: productName.value,
                article: productArticle.value
            }));
        });

        productArticle.addEventListener('input', () => {
            localStorage.setItem('currentProduct', JSON.stringify({
                name: productName.value,
                article: productArticle.value
            }));
        });

        // Templates management
        let templates = JSON.parse(localStorage.getItem('checklistTemplates') || '[]');
        
        function saveTemplates() {
            localStorage.setItem('checklistTemplates', JSON.stringify(templates));
        }

        function renderTemplatesList() {
            const list = document.getElementById('templatesList');
            if (templates.length === 0) {
                list.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìù</div><p>–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö —à–∞–±–ª–æ–Ω–æ–≤</p></div>';
                return;
            }
            
            list.innerHTML = templates.map((t, i) => `
                <div class="template-list-item">
                    <div class="template-text">${t}</div>
                    <button class="template-delete" onclick="deleteTemplate(${i})">‚úï</button>
                </div>
            `).join('');
        }

        window.deleteTemplate = function(index) {
            if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —à–∞–±–ª–æ–Ω?')) {
                templates.splice(index, 1);
                saveTemplates();
                renderTemplatesList();
                showToast('–®–∞–±–ª–æ–Ω —É–¥–∞–ª—ë–Ω');
            }
        };

        document.getElementById('addTemplate').addEventListener('click', () => {
            const text = document.getElementById('newTemplateText').value.trim();
            if (text) {
                templates.push(text);
                saveTemplates();
                renderTemplatesList();
                document.getElementById('newTemplateText').value = '';
                showToast('–®–∞–±–ª–æ–Ω –¥–æ–±–∞–≤–ª–µ–Ω');
            }
        });

        // Templates dropdown
        const templatesDropdown = document.getElementById('templatesDropdown');
        
        document.getElementById('showTemplates').addEventListener('click', () => {
            templatesDropdown.classList.toggle('show');
            if (templatesDropdown.classList.contains('show')) {
                templatesDropdown.innerHTML = templates.length === 0 
                    ? '<div style="padding: 8px; text-align: center; color: var(--text-secondary);">–ù–µ—Ç —à–∞–±–ª–æ–Ω–æ–≤</div>'
                    : templates.map(t => `<div class="template-item">${t}</div>`).join('');
                
                templatesDropdown.querySelectorAll('.template-item').forEach((el, i) => {
                    el.addEventListener('click', () => {
                        notesText.value += (notesText.value ? '\n' : '') + templates[i];
                        localStorage.setItem('drawingNotes', notesText.value);
                        templatesDropdown.classList.remove('show');
                        showToast('–®–∞–±–ª–æ–Ω –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∑–∞–º–µ—Ç–∫–∏');
                    });
                });
            }
        });

        // Templates modal
        const templatesModal = document.getElementById('templatesModal');
        
        document.getElementById('manageTemplates').addEventListener('click', () => {
            renderTemplatesList();
            templatesModal.classList.add('show');
        });

        document.getElementById('closeTemplates').addEventListener('click', () => {
            templatesModal.classList.remove('show');
        });

        document.getElementById('closeTemplatesBtn').addEventListener('click', () => {
            templatesModal.classList.remove('show');
        });

        templatesModal.addEventListener('click', (e) => {
            if (e.target === templatesModal) templatesModal.classList.remove('show');
        });

        // History management
        let history = JSON.parse(localStorage.getItem('checkHistory') || '[]');

        function saveToHistory() {
            const entry = {
                date: new Date().toISOString(),
                productName: productName.value || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è',
                productArticle: productArticle.value || '‚Äî',
                checkedCount: Object.values(checklistState).filter(v => v).length,
                totalCount: currentChecklist.reduce((sum, section) => sum + section.items.length, 0),
                notes: notesText.value
            };
            
            history.unshift(entry);
            if (history.length > 50) history = history.slice(0, 50); // Keep last 50
            localStorage.setItem('checkHistory', JSON.stringify(history));
        }

        function renderHistory() {
            const list = document.getElementById('historyList');
            
            if (history.length === 0) {
                list.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìú</div><p>–ò—Å—Ç–æ—Ä–∏—è –ø—Ä–æ–≤–µ—Ä–æ–∫ –ø—É—Å—Ç–∞</p></div>';
                return;
            }

            list.innerHTML = history.map((entry, i) => {
                const date = new Date(entry.date);
                const dateStr = date.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric' });
                const timeStr = date.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
                
                return `
                    <div class="history-item" onclick="loadHistoryEntry(${i})">
                        <div class="history-item-header">
                            <div class="history-item-title">${entry.productName}</div>
                            <div class="history-item-date">${dateStr} ${timeStr}</div>
                        </div>
                        <div class="history-item-article">–ê—Ä—Ç: ${entry.productArticle}</div>
                        <div class="history-item-stats">‚úì ${entry.checkedCount} –∏–∑ ${entry.totalCount}</div>
                    </div>
                `;
            }).join('');
        }

        window.loadHistoryEntry = function(index) {
            const entry = history[index];
            if (confirm(`–ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ "${entry.productName}"?`)) {
                productName.value = entry.productName === '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è' ? '' : entry.productName;
                productArticle.value = entry.productArticle === '‚Äî' ? '' : entry.productArticle;
                notesText.value = entry.notes || '';
                
                localStorage.setItem('currentProduct', JSON.stringify({
                    name: productName.value,
                    article: productArticle.value
                }));
                localStorage.setItem('drawingNotes', notesText.value);
                
                document.getElementById('historyModal').classList.remove('show');
                showToast('–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã');
            }
        };

        document.getElementById('showHistory').addEventListener('click', () => {
            renderHistory();
            document.getElementById('historyModal').classList.add('show');
        });

        document.getElementById('closeHistory').addEventListener('click', () => {
            document.getElementById('historyModal').classList.remove('show');
        });

        document.getElementById('closeHistoryBtn').addEventListener('click', () => {
            document.getElementById('historyModal').classList.remove('show');
        });

        document.getElementById('clearHistory').addEventListener('click', () => {
            if (confirm('–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é –ø—Ä–æ–≤–µ—Ä–æ–∫?')) {
                history = [];
                localStorage.setItem('checkHistory', JSON.stringify(history));
                renderHistory();
                showToast('–ò—Å—Ç–æ—Ä–∏—è –æ—á–∏—â–µ–Ω–∞');
            }
        });

        document.getElementById('historyModal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('historyModal')) {
                document.getElementById('historyModal').classList.remove('show');
            }
        });

        // Copy for Telegram (HTML formatting)
        document.getElementById('copyTelegram').addEventListener('click', () => {
            saveToHistory();
            
            let result = '';
            
            if (productName.value || productArticle.value) {
                result += '<b>üìã –ü–†–û–í–ï–†–ö–ê –ß–ï–†–¢–ï–ñ–ê</b>\n\n';
                if (productName.value) result += `<b>–ò–∑–¥–µ–ª–∏–µ:</b> ${productName.value}\n`;
                if (productArticle.value) result += `<b>–ê—Ä—Ç–∏–∫—É–ª:</b> ${productArticle.value}\n`;
                result += '\n';
            } else {
                result += '<b>üìã –ü–†–û–í–ï–†–ö–ê –ß–ï–†–¢–ï–ñ–ê</b>\n\n';
            }

            const now = new Date();
            result += `<i>–î–∞—Ç–∞: ${now.toLocaleDateString('ru-RU')}, ${now.toLocaleTimeString('ru-RU', {hour: '2-digit', minute: '2-digit'})}</i>\n\n`;

            let totalChecked = 0;
            let totalItems = 0;

            currentChecklist.forEach(section => {
                result += `<b>${section.section}</b>\n`;
                section.items.forEach((item, itemIndex) => {
                    const key = `${section.section}-${itemIndex}`;
                    const checked = checklistState[key];
                    totalItems++;
                    if (checked) totalChecked++;
                    result += `  ${checked ? '‚úÖ' : '‚ùå'} ${item}\n`;
                });
                result += '\n';
            });

            result += `<b>–í—ã–ø–æ–ª–Ω–µ–Ω–æ:</b> ${totalChecked} –∏–∑ ${totalItems}\n`;
            result += '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n';

            if (notesText.value.trim()) {
                result += `<b>üìù –ó–∞–º–µ—á–∞–Ω–∏—è:</b>\n${notesText.value.trim()}`;
            }

            navigator.clipboard.writeText(result).then(() => {
                showToast('üì± –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ –¥–ª—è Telegram');
            });
        });

        // Backup functions
        document.getElementById('exportBackup').addEventListener('click', () => {
            const backup = {
                version: '1.0',
                exportDate: new Date().toISOString(),
                checklist: currentChecklist,
                checklistState: checklistState,
                templates: templates,
                history: history,
                currentProduct: {
                    name: productName.value,
                    article: productArticle.value
                },
                notes: notesText.value
            };

            const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `pdf-checker-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('üíæ –ë—ç–∫–∞–ø —Å–æ—Ö—Ä–∞–Ω—ë–Ω');
        });

        document.getElementById('importBackup').addEventListener('click', () => {
            document.getElementById('backupFile').click();
        });

        document.getElementById('backupFile').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const backup = JSON.parse(event.target.result);
                    
                    if (!backup.version) {
                        showToast('‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞');
                        return;
                    }

                    if (confirm('–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ –±—ç–∫–∞–ø–∞? –¢–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –∑–∞–º–µ–Ω–µ–Ω—ã.')) {
                        if (backup.checklist) {
                            currentChecklist = backup.checklist;
                            localStorage.setItem('customChecklist', JSON.stringify(currentChecklist));
                        }
                        
                        if (backup.checklistState) {
                            checklistState = backup.checklistState;
                            localStorage.setItem('checklistState', JSON.stringify(checklistState));
                        }
                        
                        if (backup.templates) {
                            templates = backup.templates;
                            saveTemplates();
                        }
                        
                        if (backup.history) {
                            history = backup.history;
                            localStorage.setItem('checkHistory', JSON.stringify(history));
                        }
                        
                        if (backup.currentProduct) {
                            productName.value = backup.currentProduct.name || '';
                            productArticle.value = backup.currentProduct.article || '';
                            localStorage.setItem('currentProduct', JSON.stringify(backup.currentProduct));
                        }
                        
                        if (backup.notes) {
                            notesText.value = backup.notes;
                            localStorage.setItem('drawingNotes', backup.notes);
                        }

                        renderChecklist();
                        showToast('‚úÖ –ë—ç–∫–∞–ø –∑–∞–≥—Ä—É–∂–µ–Ω');
                    }
                } catch (err) {
                    showToast('‚ùå –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞');
                    console.error(err);
                }
            };
            reader.readAsText(file);
            e.target.value = '';
        });

        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2500);
        }

        loadChecklistState();
        loadChecklistData();
        renderChecklist();

        if (!isMobile) {
            sidebar.classList.remove('collapsed');
            updatePdfContainerMargin();
        }

        // Update on resize
        window.addEventListener('resize', () => {
            isMobile = window.innerWidth <= 768;
            updatePdfContainerMargin();
        });
    </script>
</body>
</html>
